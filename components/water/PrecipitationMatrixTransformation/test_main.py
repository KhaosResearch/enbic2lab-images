import os
from tempfile import TemporaryDirectory

import pytest
import pandas as pd

from main import precipitation_matrix_transformation

input_data = pd.DataFrame(
    data={
        "INDICATIVO": [
            4514,
            4514,
            4514,
            4514,
            4514,
            4514,
            4514,
            4514,
            4514,
            4514,
            4514,
            4514,
        ],
        "AÃ‘O": [1971, 1971, 1971, 1971, 1971, 1971, 1971, 1971, 1971, 1971, 1971, 1972],
        "MES": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
        "NOMBRE": [
            "JABUGO",
            "JABUGO",
            "JABUGO",
            "JAMON",
            "JABUGO",
            "JABUGO",
            "JAMON",
            "JAMON",
            "JABUGO",
            "JABUGO",
            "JABUGO",
            "JABUGO",
        ],
        "ALTITUD": [684, 684, 684, 684, 684, 684, 684, 684, 684, 684, 684, 684],
        "C_X": [
            172046,
            172046,
            172046,
            172046,
            172046,
            172046,
            172046,
            172046,
            172046,
            172046,
            172046,
            172046,
        ],
        "C_Y": [
            4203292,
            4203292,
            4203292,
            4203292,
            4203292,
            4203292,
            4203292,
            4203292,
            4203292,
            4203292,
            4203292,
            4203292,
        ],
        "NOM_PROV": [
            "HUELVA",
            "HUELVA",
            "HUELVA",
            "HUELVA",
            "HUELVA",
            "HUELVA",
            "HUELVA",
            "HUELVA",
            "HUELVA",
            "HUELVA",
            "HUELVA",
            "HUELVA",
        ],
        "LONGITUD": [
            643502,
            643502,
            643502,
            643502,
            643502,
            643502,
            643502,
            643502,
            643502,
            643502,
            643502,
            643502,
        ],
        "LATITUD": [
            375505,
            375505,
            375505,
            375505,
            375505,
            375505,
            375505,
            375505,
            375505,
            375505,
            375505,
            375505,
        ],
        "P1": [0, 0, 0, 233, 0, 0, 0, 0, 0, 0, 0, 123],
        "P2": [0, 0, 0, 51, 0, 0, 0, 0, 0, 0, 0, 391],
        "P3": [129, 0, 0, 29, 0, 0, 0, 0, 0, 0, 0, 0],
        "P4": [0, 0, 0, 22, 69, 315, 0, 0, 0, 0, 0, 0],
        "P5": [0, 0, 0, 845, 34, 259, 0, 0, 0, 15, 0, 0],
        "P6": [0, 0, 0, 427, 0, 200, 0, 0, 0, 0, 0, 0],
        "P7": [0, 0, 141, 149, 0, 0, 0, 0, 0, 0, 0, 0],
        "P8": [0, 0, 0, 155, 0, 0, 0, 89, 0, 0, 0, 0],
        "P9": [0, 0, 0, 0, 0, 49, 0, 0, 0, 0, 0, 0],
        "P10": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        "P11": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        "P12": [238, 0, 0, 85, 0, 0, 0, 0, 0, 15, 0, 0],
        "P13": [96, 0, 34, 0, 26, 0, 0, 0, 0, 0, 0, 0],
        "P14": [57, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        "P15": [0, 0, 0, 48, 0, 0, 0, 0, 0, 0, 0, 0],
        "P16": [184, 0, 49, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        "P17": [85, 0, 108, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        "P18": [66, 0, 103, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        "P19": [236, 0, 156, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        "P20": [375, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        "P21": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 436],
        "P22": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        "P23": [350, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        "P24": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        "P25": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        "P26": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        "P27": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        "P28": [0, 0, 0, 0, 0, 0, 25, 0, 0, 0, 103, 0],
        "P29": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        "P30": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        "P31": [215, 0, 0, 130, 0, 0, 0, 0, 0, 81, 69, 148],
    }
)


def test_precipitation_matrix_transformation():
    delimiter = ";"
    with TemporaryDirectory() as temp_dir:
        temp_input_file = os.path.join(temp_dir, "input_test.csv")
        temp_output_file = os.path.join(temp_dir, "output_test.csv")

        pd.DataFrame(input_data).to_csv(temp_input_file, index=False, sep=delimiter)

        precipitation_matrix_transformation(
            temp_input_file, temp_output_file, delimiter
        )

        assert os.path.exists(temp_output_file)
        assert os.path.getsize(temp_output_file) > 0
